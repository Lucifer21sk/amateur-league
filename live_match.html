<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Match</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="match-container">

  <div class="team-panel">
    <img id="homeLogo" class="team-logo">
    <h2 id="homeName">DOMÁCI</h2>

    <div class="team-spacer"></div>

    <div class="team-actions">
      <button id="homeGoalBtn" class="goal-btn" onclick="openGoal('home')">Gól</button>
      <button id="homePenaltyBtn" class="penalty-btn" onclick="openPenalty('home')">Trest</button>
    </div>
  </div>

  <div class="center-stack">

    <div class="score-box">
      <span id="homeScore">0</span>
      :
      <span id="awayScore">0</span>
    </div>

    <div class="match-phase" id="matchPhase">
      Hrací čas
    </div>

  </div>

  <div class="team-panel">
    <img id="awayLogo" class="team-logo">
    <h2 id="awayName">HOSTIA</h2>

    <div class="team-spacer"></div>

    <div class="team-actions">
      <button id="awayGoalBtn" class="goal-btn" onclick="openGoal('away')">Gól</button>
      <button id="awayPenaltyBtn" class="penalty-btn" onclick="openPenalty('away')">Trest</button>
    </div>
  </div>

</div>

<button class="action-btn end-match-btn" onclick="endMatch()">
  Koniec zápasu
</button>

<div id="goalModal" class="modal">
  <div class="modal-box">
    <h3>GÓL</h3>

    <input id="goalTime" placeholder="Čas (mm:ss)" inputmode="numeric">
    <input placeholder="Strelec – číslo" id="goalScorer" inputmode="numeric" pattern="[0-9]*">
    <input placeholder="Asistencia 1" id="goalAssist1" inputmode="numeric" pattern="[0-9]*">
    <input placeholder="Asistencia 2" id="goalAssist2" inputmode="numeric" pattern="[0-9]*">

    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal()">Zrušiť</button>
      <button class="modal-confirm" onclick="confirmGoal()">✓</button>
    </div>
  </div>
</div>

<div id="penaltyModal" class="modal">
  <div class="modal-box">
    <h3>TREST</h3>

    <input id="penaltyTime" placeholder="Čas (mm:ss)" inputmode="numeric">
    <input placeholder="Hráč – číslo" id="penaltyPlayer" inputmode="numeric" pattern="[0-9]*">

    <select id="penaltyType">
      <option>1,5 min</option>
      <option>2 + 2 min</option>
      <option>10 min</option>
      <option>Do konca zápasu</option>
    </select>

    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal()">Zrušiť</button>
      <button class="modal-confirm" onclick="confirmPenalty()">✓</button>
    </div>
  </div>
</div>

<script>
/* =========================
   GLOBAL VARIABLES & SETUP
   ========================= */
const params = new URLSearchParams(window.location.search);
const matchId = params.get("match"); 
const homeTeamId = params.get("home");
const awayTeamId = params.get("away");

if (!matchId) {
    alert("Chyba: Nie je zadané ID zápasu. Vráťte sa na výber tímov.");
}

let homeTeam = null;
let awayTeam = null;
let teamsLoaded = false;

let homeScore = 0;
let awayScore = 0;
let activeTeam = null;

const goalModal = document.getElementById("goalModal");
const penaltyModal = document.getElementById("penaltyModal");

/* =========================
   INITIALIZATION (ON LOAD)
   ========================= */
window.onload = async () => {
    await loadTeamLogos();
    if (matchId) {
        await restoreMatchState();
    }
};

/* =========================
   1. RESTORE STATE (REFRESH SAFETY)
   ========================= */
async function restoreMatchState() {
  if (!matchId) return;

  try {
    const res = await fetch(`https://Kaneki21.pythonanywhere.com/matches/${matchId}/score`);
    const data = await res.json();

    if (data.status === "ok") {
      homeScore = data.home_goals;
      awayScore = data.away_goals;
      updateScoreBoard();
    }
  } catch (err) { console.error(err); }
}

/* =========================
   2. LOAD TEAMS
   ========================= */
async function loadTeamLogos() {
  try {
    const res = await fetch("https://Kaneki21.pythonanywhere.com/teams");
    const teams = await res.json();

    homeTeam = teams.find(t => String(t.id) === String(homeTeamId));
    awayTeam = teams.find(t => String(t.id) === String(awayTeamId));

    if (!homeTeam || !awayTeam) {
      console.error("Team IDs not found", homeTeamId, awayTeamId);
      return;
    }

    document.getElementById("homeName").innerText = homeTeam.name;
    document.getElementById("awayName").innerText = awayTeam.name;
    document.getElementById("homeLogo").src = "logos/" + homeTeam.logo;
    document.getElementById("awayLogo").src = "logos/" + awayTeam.logo;

    teamsLoaded = true;
  } catch (err) {
    console.error("Failed to load teams", err);
  }
}

/* =========================
   UI UPDATER
   ========================= */
function updateScoreBoard() {
    document.getElementById("homeScore").textContent = homeScore;
    document.getElementById("awayScore").textContent = awayScore;
}

/* =========================
   4. MODALS & INPUTS
   ========================= */
function openGoal(team) {
  activeTeam = team;
  goalModal.classList.add("active");
}

function openPenalty(team) {
  activeTeam = team;
  penaltyModal.classList.add("active");
}

function closeModal() {
  goalModal.classList.remove("active");
  penaltyModal.classList.remove("active");
}

function clearGoalModal() {
  document.getElementById("goalTime").value = "";
  document.getElementById("goalScorer").value = "";
  document.getElementById("goalAssist1").value = "";
  document.getElementById("goalAssist2").value = "";
}

function clearPenaltyModal() {
  document.getElementById("penaltyTime").value = "";
  document.getElementById("penaltyPlayer").value = "";
  document.getElementById("penaltyType").value = "";
}

// Auto-format time inputs (0430 -> 04:30)
function setupTimeInput(id) {
  const input = document.getElementById(id);
  input.addEventListener("input", () => {
    let digits = input.value.replace(/\D/g, "").slice(0, 4);
    if (digits.length >= 3) {
      input.value = digits.slice(0, 2) + ":" + digits.slice(2);
    } else {
      input.value = digits;
    }
  });
}
setupTimeInput("goalTime");
setupTimeInput("penaltyTime");

/* =========================
   5. ACTIONS (GOAL & PENALTY)
   ========================= */
async function confirmGoal() {
  const minute = document.getElementById("goalTime").value;
  const scorer = document.getElementById("goalScorer").value;
  const assist1 = document.getElementById("goalAssist1").value;
  const assist2 = document.getElementById("goalAssist2").value;

  if (!minute || !scorer) {
    alert("Vyplň čas a strelca");
    return;
  }

  if (!teamsLoaded) {
    alert("Tímy sa ešte načítavajú...");
    return;
  }

  const teamId = activeTeam === "home" ? homeTeamId : awayTeamId;

  const payload = {
    match_id: matchId,
    team_id: teamId,
    scorer_number: Number(scorer),
    assist1_number: assist1 ? Number(assist1) : null,
    assist2_number: assist2 ? Number(assist2) : null,
    minute: minute
  };

  try {
    const res = await fetch("https://Kaneki21.pythonanywhere.com/goal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (result.status === "ok") {
      if (activeTeam === "home") homeScore++;
      else awayScore++;
      
      updateScoreBoard();
      clearGoalModal();
      closeModal();
    } else {
      alert("Chyba pri ukladaní gólu");
    }

  } catch (err) {
    console.error(err);
    alert("Chyba spojenia so serverom");
  }
}

async function confirmPenalty() {
  const minute = document.getElementById("penaltyTime").value;
  const player = document.getElementById("penaltyPlayer").value;
  const type = document.getElementById("penaltyType").value;

  if (!minute || !player || !type) {
    alert("Vyplň všetky polia");
    return;
  }

  const teamId = activeTeam === "home" ? homeTeamId : awayTeamId;

  const payload = {
    match_id: matchId,
    team_id: teamId,
    player_number: Number(player),
    minute: minute,
    type: type
  };

  try {
    const res = await fetch("https://Kaneki21.pythonanywhere.com/penalty", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    if (result.status === "ok") {
      clearPenaltyModal();
      closeModal();
    } else {
      alert("Chyba servera pri treste");
    }

  } catch (err) {
    console.error(err);
    alert("Chyba spojenia");
  }
}

/* =========================
   6. END MATCH
   ========================= */
async function endMatch() {
  if (!confirm("Naozaj chcete ukončiť zápas?")) return;

  let winnerId = null;

  if (homeScore > awayScore) winnerId = homeTeamId;
  else if (awayScore > homeScore) winnerId = awayTeamId;
  else winnerId = null; // Zápas skončil remízou

  try {
    await fetch("https://Kaneki21.pythonanywhere.com/matches/end", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            match_id: matchId,
            winner_team_id: winnerId,
            phase: "normal", // Vždy posielame normal
            home_score: homeScore,
            away_score: awayScore
        })
    });
    window.location.href = `post_match.html?match=${matchId}`;
  } catch (e) {
    console.error(e);
    alert("Chyba pri ukončovaní zápasu.");
  }
}
</script>

</body>
</html>